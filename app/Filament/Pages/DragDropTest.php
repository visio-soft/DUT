<?php

namespace App\Filament\Pages;

use Filament\Pages\Page;
use Filament\Actions\Action;
use App\Models\Obje;
use App\Models\Oneri;
use App\Models\ProjectDesign;
use App\Models\Category;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;

class DragDropTest extends Page
{
    protected static ?string $navigationIcon = 'heroicon-o-paint-brush';

    protected static string $view = 'filament.pages.drag-drop-test';

    protected static ?string $title = 'Landscape Designer';

    protected static ?string $navigationLabel = 'Peyzaj Tasarƒ±mcƒ±sƒ±';

    protected static bool $shouldRegisterNavigation = true; // Bu sayfayƒ± navigation'da g√∂ster

    public ?string $projectImage = null;
    public ?int $projectId = null;
    public ?Oneri $project = null;

    public function mount(): void
    {
        // Sadece yetkili kullanƒ±cƒ±lar eri≈üebilsin
        if (!Auth::check()) {
            Log::warning('üö® [AUTH] Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü, eri≈üim reddedildi');
            abort(403);
        }

        Log::info('üîê [AUTH] Kullanƒ±cƒ± giri≈üi doƒürulandƒ±', [
            'user_id' => Auth::id(),
            'user_email' => Auth::user()->email ?? 'N/A'
        ]);

        // URL'den parametreleri al
        $this->projectImage = request()->get('image');
        $this->projectId = request()->get('project_id');

        Log::info('üì• [MOUNT] URL parametreleri alƒ±ndƒ±', [
            'project_id' => $this->projectId,
            'project_image' => $this->projectImage
        ]);

        // Proje varsa y√ºkle
        if ($this->projectId) {
            $this->project = Oneri::find($this->projectId);

            if (!$this->project) {
                Log::error('‚ùå [MOUNT] Proje bulunamadƒ±', ['project_id' => $this->projectId]);
                abort(404, 'Proje bulunamadƒ±');
            }

            Log::info('‚úÖ [MOUNT] Proje y√ºklendi', [
                'project_id' => $this->project->id,
                'project_title' => $this->project->title
            ]);

            // Proje resmi URL'ini g√ºncelle
            if ($this->project->hasMedia('images')) {
                $this->projectImage = $this->project->getFirstMediaUrl('images');
                Log::info('üñºÔ∏è [MOUNT] Proje resmi bulundu', ['image_url' => $this->projectImage]);
            } else {
                Log::info('üì∑ [MOUNT] Proje resmi bulunamadƒ±');
            }
        } else {
            Log::info('‚ÑπÔ∏è [MOUNT] Project ID belirtilmemi≈ü');
        }
    }

    public function getViewData(): array
    {
        Log::info('üìä [VIEW DATA] getViewData √ßaƒürƒ±ldƒ±');

        // Kategorileri √ßek - sadece Obje modelindeki sabit kategoriler
        $kategoriler = [];

        // Sadece Obje modelindeki sabit kategorileri kullan
        foreach (Obje::CATEGORIES as $key => $name) {
            $kategoriler[] = [
                'id' => $key,
                'name' => $name,
                'type' => 'static' // Sabit kategori
            ];
        }

        Log::info('üìÇ [VIEW DATA] Kategoriler hazƒ±rlandƒ±', ['count' => count($kategoriler)]);

        // Objeler tablosundan t√ºm objeleri √ßek
        $objeler = Obje::all()->map(function ($obje) {
            return [
                'id' => $obje->id,
                'name' => $obje->name, // Yeni ƒ∞ngilizce s√ºtun adƒ±
                'category' => $obje->category, // Yeni ƒ∞ngilizce s√ºtun adƒ±
                'image_url' => $obje->hasMedia('images') ? $obje->getFirstMediaUrl('images') : null,
            ];
        });

        Log::info('üóÇÔ∏è [VIEW DATA] Objeler hazƒ±rlandƒ±', ['count' => $objeler->count()]);

        // Mevcut tasarƒ±mƒ± y√ºkle (eƒüer varsa)
        $existingDesign = null;
        
        if ($this->project) {
            // √ñnce Project modelindeki design_landscape alanƒ±nƒ± kontrol et
            if ($this->project->design_landscape) {
                $existingDesign = $this->project->design_landscape;
                Log::info('üé® [VIEW DATA] Mevcut tasarƒ±m Project.design_landscape\'dan y√ºklendi');
            }
            // Eƒüer yoksa, eski ProjectDesign tablosunu kontrol et
            elseif ($this->project->design && $this->project->design->design_data) {
                $existingDesign = $this->project->design->design_data;
                Log::info('üé® [VIEW DATA] Mevcut tasarƒ±m ProjectDesign.design_data\'dan y√ºklendi');
            } else {
                Log::info('üÜï [VIEW DATA] Mevcut tasarƒ±m bulunamadƒ±');
            }
        }

        $viewData = [
            'objeler' => $objeler,
            'kategoriler' => $kategoriler,
            'project_id' => $this->projectId,
            'project_image' => $this->projectImage,
            'existing_design' => $existingDesign,
            'project' => $this->project,
        ];

        Log::info('‚úÖ [VIEW DATA] View data hazƒ±rlandƒ±', [
            'objeler_count' => $objeler->count(),
            'kategoriler_count' => count($kategoriler),
            'project_id' => $this->projectId,
            'has_existing_design' => !is_null($existingDesign)
        ]);

        return $viewData;
    }

    protected function getActions(): array
    {
        return [
            Action::make('goBack')
                ->label('Geri D√∂n')
                ->icon('heroicon-o-arrow-left')
                ->color('gray')
                ->url(url('/admin/oneris')),

            Action::make('saveDesign')
                ->label('Tasarƒ±mƒ± Kaydet ve Tamamla')
                ->icon('heroicon-o-check-circle')
                ->color('success')
                ->action(fn() => $this->saveDesignData()),
        ];
    }

    public function saveDesignData()
    {
        if (!$this->project) {
            \Filament\Notifications\Notification::make()
                ->title('Hata!')
                ->body('Proje bulunamadƒ±!')
                ->danger()
                ->send();
            return;
        }

        // JavaScript'ten tasarƒ±m verilerini al ve kaydet
        $this->js('
            console.log("üöÄ [SAVE] Tasarƒ±m kaydetme i≈ülemi ba≈üladƒ±");
            console.log("üìä [SAVE] designElements array:", designElements);
            
            if (!designElements || designElements.length === 0) {
                console.warn("‚ö†Ô∏è [SAVE] Tasarƒ±mda hi√ß element yok!");
                alert("Kaydetmek i√ßin √∂nce tasarƒ±ma element eklemelisiniz!");
                return;
            }
            
            const elements = designElements.map(element => ({
                obje_id: element.obje_id,
                x: element.x,
                y: element.y,
                width: element.width,
                height: element.height,
                rotation: element.rotation || 0,
                aspectRatio: element.aspectRatio || 1,
                scale: element.scale
            }));
            
            console.log("üì¶ [SAVE] Hazƒ±rlanan elements:", elements);

            const design = {
                project_id: ' . $this->project->id . ',
                elements: elements,
                timestamp: new Date().toISOString(),
                total_elements: elements.length,
                metadata: {
                    elementsWithRotation: elements.filter(el => el.rotation && el.rotation !== 0).length,
                    totalRotation: elements.reduce((sum, el) => sum + Math.abs(el.rotation || 0), 0)
                }
            };
            
            console.log("üíæ [SAVE] Final tasarƒ±m verisi:", design);
            console.log("üìû [SAVE] storeDesignData √ßaƒürƒ±lƒ±yor...");

            $wire.call("storeDesignData", design);
        ');
    }

    public function storeDesignData($designData)
    {
        try {
            Log::info('üöÄ [BACKEND SAVE] Tasarƒ±m kaydetme ba≈üladƒ±', [
                'project_id' => $this->project->id,
                'design_data_keys' => array_keys($designData ?? []),
                'elements_count' => isset($designData['elements']) ? count($designData['elements']) : 0
            ]);

            if (!$designData || !isset($designData['elements']) || empty($designData['elements'])) {
                \Filament\Notifications\Notification::make()
                    ->title('Hata!')
                    ->body('Tasarƒ±m verisi bo≈ü! √ñnce tasarƒ±ma element eklemelisiniz.')
                    ->warning()
                    ->send();
                return;
            }

            $elementsCount = is_array($designData) && isset($designData['total_elements']) ? $designData['total_elements'] : 0;

            Log::info('üíæ [BACKEND SAVE] Veritabanƒ±na kaydediliyor', [
                'elements_count' => $elementsCount,
                'design_data' => $designData
            ]);

            // Tasarƒ±m verilerini Project modeline kaydet (yeni yakla≈üƒ±m)
            $this->project->update(['design_landscape' => $designData]);

            // Tasarƒ±m verilerini ProjectDesign tablosuna da kaydet (geriye uyumluluk i√ßin)
            ProjectDesign::updateOrCreate(
                ['project_id' => $this->project->id],
                ['design_data' => $designData]
            );

            // Projeyi tamamlanmƒ±≈ü olarak i≈üaretle
            $this->project->update(['design_completed' => true]);

            Log::info('‚úÖ [BACKEND SAVE] Tasarƒ±m ba≈üarƒ±yla kaydedildi', [
                'project_id' => $this->project->id,
                'elements_count' => $elementsCount
            ]);

            // Ba≈üarƒ± mesajƒ± ve y√∂nlendirme
            \Filament\Notifications\Notification::make()
                ->title('Ba≈üarƒ±lƒ±!')
                ->body("Tasarƒ±m ba≈üarƒ±yla kaydedildi! {$elementsCount} element ve rotasyon verileri dahil edildi.")
                ->success()
                ->send();

            $this->js("setTimeout(() => window.location.href = '/admin/oneris', 100);");

        } catch (\Exception $e) {
            Log::error('‚ùå [BACKEND SAVE] Tasarƒ±m kayƒ±t hatasƒ±', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);

            \Filament\Notifications\Notification::make()
                ->title('Hata!')
                ->body('Tasarƒ±m kaydedilirken bir hata olu≈ütu: ' . $e->getMessage())
                ->danger()
                ->send();
        }
    }

    public function getHeading(): string
    {
        return 'Tasarƒ±m Aracƒ±';
    }

    public function getSubheading(): ?string
    {
        return 'Projeniz i√ßin tasarƒ±mƒ± olu≈üturun. Elementleri s√ºr√ºkleyip bƒ±rakarak tasarƒ±mƒ±nƒ±zƒ± yapabilirsiniz.';
    }
}
